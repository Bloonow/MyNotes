# 字符编码

字符编码（character encoding）是指将数字分配给图形字符（graphical character）的过程，特指人类语言的书面字符，以便字符信息在计算中存储和在网络中传输。对给定语言或字符范围内的所有字符进行编码，字符的编码数值称为代码点（code point），而构成的集合则称为代码空间（code space）、代码页（code page）、内码表（code table），或直接称为字符集（character set）。


非正式地，术语字符编码、字符集、代码页等通常可以互换使用，但随着更复杂字符编码的出现，这些术语的定义与区分变得很重要。

- 字符（character），具有语义价值的最小文本单位。
- 字符集（character set），用于表示文本的字符元素的集合。例如，拉丁字母和希腊字母都是字符集。
- 编码字符集（coded character set），将字符映射到唯一数字集的字符集，由于历史原因，通常也称为代码页（code page）。
- 字符库（character repertoire），由特定编码字符集表示的字符集。它可以是封闭的，意味着没有新标准的情况下不允许添加任何新内容，例如ASCII或多数ISO-8859系列；或者可以是开放的，允许添加新内容，例如，Unicode或有限范围内的Windows代码页。
- 代码点（code point），编码字符集中字符的值或位置，即一个字符对应的唯一数字编码。
- 代码空间（code space），编码字符集所覆盖的数值范围。
- 代码单元（code unit），字符编码中可以表示字符的最小位组合，即字符编码的字长。常见的代码单元包括7位、8位、16位、32位等。在某些编码中，某些字符是使用多个代码单元进行编码的，这种编码称为可变宽度编码。

一种给定语言或字符范围可以有多种不同的编码方式。最常见的例子即是，将拉丁字母、阿拉伯数字、一些特殊字符的集合编码成摩斯电码（Morse Code）、美国标准信息交换码（American Standard Code for Information Interchange，ASCII）等。

常用语言的常用字符集如下表所示。

| 语言                  | 缩写  | 字符集                          |
| --------------------- | ----- | ------------------------------- |
| Chinese (Simplified)  | zh-CN | GB2312, GBK, GB18030            |
| Chinese (Traditional) | zh-TW | Big5, Big5-HKSCS                |
| English               | en    | ASCII, ISO-8859-1, Windows-1252 |
| Japanese              | ja    | Shift_JIS, ISO-2022-JP, EUC-JP  |

## ASCII

ASCII（American Standard Code for Information Interchange，美国标准信息交换码）是基于拉丁字母的一套计算机编码，主要用于显示现代英语和其他西欧语言。

它占用一个8位的字节，实际使用了从00000000到01111111的共128个数字。

其中，数字0\~31表示一共32个控制字符或通信专用字符。例如，索引0位置是NULL（空值，C数组的'\0'），以及LF（换行）、CR（回车）、FF（换页）、BS（退格）、BEL（响铃）等，索引127位置是DEL（删除）字符。这些特殊字符或通信专用字符没有特定的图形显示，但会根据不同的应用程序，对文本的显示有不同的影响。

其中，数字32\~126表示一共95个显示字符。例如，索引32位置是空格，索引48\~57位置是数字0\~9，索引65\~90位置是大写字母A\~Z，索引97\~122位置是小写字母a\~z，其余为一些标点符号、运算符等。

标准的ASCII将每个字节的最高位作为校验位，用于在传输时进行奇偶校验。后来，将ASCII所使用字节的最高位[7]用作扩展，括扩充了从10000000到11111111的共128个数字，称为扩展ASCII码。扩展ASCII码允许将每个字节的最高位用于确定附加的128个特殊符号字符、外来字母和圆形符号。

<img src="字符编码.assets/ASCII表.jpg" style="zoom: 67%;" />

## 中文字符编码

中文字符（即汉字）的编码包括汉字的输入码（字符编码），汉字内码，汉字字形码（字体）三种，分别用于编码表示、计算机存储、显示输出。

GB2312。在1981年实施的国家标准GB 2312-1980中，每个汉字编码用两字节表示，收录了一级汉字3755个、二级汉字3008个、各种符号682个，共计7445个。整个字符集分成94个区，每区有94个位，每个区位上只有一个字符，因此可用所在的区和位来对汉字进行编码（代码点），称为区位码，它用4位十进制数表示，前两位是区码，后两位是位码。其中，01\~09区为特殊符号；16\~55区为一级汉字，按拼音排序；56\~87区为二级汉字，按部首/笔画排序；10\~15区及88\~94区则未有编码。例如，字符`啊`是GB2312之中的第一个汉字，它的区位码就是1601。

为用计算机表示中文字符，使用两个字节的汉字国标码（代码单元）表示，它将将十进制的区位码转换为十六进制数后，再在每个字节上加上0x20偏移。因国标码两字节最高位都是0，且ASCII码的最高位也是0，为方便计算机区分中文字符和英文字符，将国标码的两个字节的最高位都置位为1，这就是汉字内码。

区位码和国标码都是输入码，它们和汉字内码的关系（十六进制）如下。
$$
国标码=(区位码)_{16}+\text{0x}2020 \\
汉字内码=(国标码)_{16}+\text{0x}8080
$$

GBK。在1995年制定的GBK标准向下与GB 2312-1980兼容，向上支持ISO 10646.1（Unicode）标准，是前者向后者过渡过程中的一个承上启下的产物。它是在GB 2312-1980标准基础上的内码扩展规范，使用了双字节编码方案，其编码范围从0x8140至0xFEFE（剔除0x##7F），共23940个码位，共收录了21003个汉字，完全兼容GB 2312-80标准，并包含了Big5编码中的所有汉字。

GB18030。在2000年公布的国家标准GB 18030是目前最新的汉字编码，共收录汉字70244个，编码标准采用1B、2B、4B，是变长多字节字符集。它对GB 2312-1980完全向后兼容，与GBK基本向后兼容，并支持Unicode的所有码位。GB 18030的当前版本为GB 18030-2005。

## Unicode

Unicode及其ISO/IEC 10646标准（通用字符集，Universal Character Set）共同构成了字符编码的统一标准。Unicode不是将字符直接映射到字节，而是单独定义了一个编码字符集，将字符映射到唯一的数字（代码点），并定义了这些代码点如何映射到一系列固定大小的数字（代码单元），以及最后这些单元如何被编码为八位字节序列。这种分解的目的是建立一个可以用多种方式编码的通用字符集。

- 抽象字符库（abstract character repertoire，ACR），是系统支持的完整抽象字符集，Unicode具有开放的字符集，新的字符可以被添加到字符集中。
- 编码字符集（coded character set，CCS），字符到代码点的映射。例如，在给定字符库中，拉丁字母表中的大写字母A由代码点65表示。
- 字符编码形式（character encoding form，CEF），代码点到代码单元的映射，将数字表示为固定长度的二进制位序列，以在计算机系统中存储。例如，以16位单元存储数字信息的系统只能在每个单元中直接表示0到65535的代码点，但可以使用多个16位单元来表示更大的代码点。该对应关系由CEF定义。
- 字符编码方案（character encoding scheme，CES），代码单元到八位字节序列的映射，以便于在基于八位字节序列的文件系统上存储或网络上传输。简单的字符编码方案包括UTF-8、UTF-16BE、UTF-32BE、UTF-16LE、UTF-32LE，复合字符编码方案包括UTF-16、UTF-32、ISO/IEC 2022。通过字节顺序标记或转义序列，可以在几种简单方案之间切换，压缩方案尝试最小化每个代码单元使用的字节数。

在Unicode中，字符可以使用`U+`后跟十六进制代码点值来表示，Unicode标准的有效代码空间范围为U+0000到U+10FFFF，分为17个平面（plane），由0x00到0x10数字标识。U+0000到U+FFFF范围内的字符是在平面0中，称为基本多语言平面（BMP），该平面包含最常用的字符，其他平面中U+10000到U+10FFFF范围内的字符称为增补字符。

## ANSI

ANSI（American National Standards Institute，美国国家标准学会），它不是某一种字符编码，而是一个标准，在不同的环境中实际上是不同的编码。不同的国家和地区制定了不同的标准，由此产生了GB2312、GBK、GB18030、Big5、Shift_JIS等各自的编码标准，这些使用多个字节来代表一个字符的各种汉字延伸编码方式，称为ANSI编码。

在简体中文Windows操作系统中，ANSI编码代表GBK编码；在繁体中文Windows操作系统中，ANSI编码代表Big5；在日文Windows操作系统中，ANSI编码代表Shift_JIS编码。

在Windows操作系统的cmd命令行中，可使用chcp命令切换当前终端使用的代码页。其中，代码页936对应GBK编码，代码页950对应Big5编码，代码页932对应Shift_JIS编码，代码页65001对应UTF-8编码。

## 键盘布局与扫描码

键盘布局是指计算机键盘等其他印刷键盘的按键、图例、键义关联的特定排列。QWERTY布局是迄今为止使用最广泛的布局，也是唯一不局限于特定地理区域的布局。

在现代计算机键盘的设计中，当按下（down）或释放（up）某个键时会向操作系统发送键位扫描代码（scancode），而不报告该键上刻印的特定字符。从技术上讲，每个键位都有一个内部引用编号，即扫描码，这些数字是按下或释放键时发送到操作系统的数字。键盘硬件可以在其固件中使用多种不同的扫描码，但考虑兼容性，以行列交叉电路实现的扫描码仍然使用最为广泛。

操作系统使用键盘映射表（keyboard mapping table）将扫描码转换为一个特定二进制字符。这意味着物理键盘可以动态映射到任何布局，而无需切换硬件组件，只需更改用于键位映射的软件即可，通常，用户可以在系统设置中更改键盘映射。现代USB键盘是即插即用的，它们在连接时会将其默认的刻印布局传达给操作系统。

随着PC-AT主机发布，IBM一同推出了具有新双向协议的键盘，以及新的PS/2键盘控制器。PS/2控制器位于主板上（目前已成为高级集成外设的一部分），早期控制器的实现是Intel 8042单芯片。随着PS/2系列的推出，键盘控制器子系统的主要变化是其扩展为同时控制键盘和鼠标，即支持双通道，通常是一个键盘和一个鼠标。对于键盘功能来说，PS2和AT控制器非常相似；然而，第二个通道（用于鼠标）的添加迫使重新定义一些状态和控制位。

原来的IBM-PC键盘（使用旧的XT接口）使用扫描码集一（scancode set 1），新的AT键盘生成不同的扫描代码，即扫描码集二（scancode set 2）。此更改可能会给需要键盘不同扫描代码的软件带来兼容性问题，为避免兼容性问题，键盘控制器支持翻译模式，即由控制器负责将扫描码集二转换为扫描码集一，此时称为翻译扫描码集二（translated scancode set 2）。

只要启用此翻译（默认启用），就无法在软件中反转它，即此转换上层系统软件不可见。例如，如果操作系统从控制器接收到字节0x81，那么无法确定由设备发送到控制器的原始数据，即无法确定是从扫描码集一中生成的0x81，还是从扫描码集二中生成的双字节0xF076并经过转换，亦或是从扫描码集三中生成的双字节0xF008并经过转换。对于实际使用扫描码集二，或使用更新的但很少使用的扫描码集三的软件，或允许在键盘端口中使用不同的设备，需要禁用此转换以避免设备中的数据被破坏。

下图所示的是U.S. PS/2标准键盘模型的刻印键位与扫描码集一（或翻译扫描码集二）的对应关系，键位右下角圈中数字表示该键的扫描码，以十六进制数表示。需要注意的是，图中只给出了键位按下（make）时的扫描码，释放（break）时的扫描码将高位0x80置1即可。

<img src="字符编码.assets/ps2 keyboard scancode.png" style="zoom: 33%;" />

大多数扫描码表示键位按下或释放，而有些扫描码则是在通信协议中使用的。例如，0x00、0xFF表示键盘错误；0xAA用于基本保证测试（Basic Assurance Test）；0xEE表示echo命令结果；0xFC表示BAT错误或鼠标传输错误；0xFD表示内部错误；0xFE表示键盘无响应（无ack确认），请求重新发送。键盘错误的三个常见原因，一是同时按下多个键，二是键盘缓冲区溢出，三是键盘和键盘控制器用于通信的串行线路上的奇偶校验错误。

使用0xE0和0xE1前缀字节执行转移操作，引入扫描码序列，而通常不用于分隔多个扫描码。前缀0xE0最初用于原始PC/XT键盘上的灰色重复按键，现在0xE0只是用于扩展代码空间。用于Pause/Break的前缀0xE1表示该键在按下时发送make/break序列，并且在释放时不执行任何操作。除Pause/Break键使用0xE1转移之外，其他转移使用0xE0，当控制器选择接受或丢弃0xE0时，会对应不同的行为。

笔记本电脑没有空间容纳普通键盘上常见的所有无意义按键。因此，数字键盘和其他按键被折叠到键盘的主要部分中。没有标签或标记为FN的键通常用于修改其他键的含义，该FN键本身不产生扫描码，它仅修改其他键产生的扫描码。